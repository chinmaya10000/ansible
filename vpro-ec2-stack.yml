--- 
- hosts: localhost
  connection: local 
  gather_facts: false
  tasks:
  - name: Import vpc variable files
    ansible.builtin.include_vars: vars/output_vars
  - name: Import vprofile setupvariable 
    ansible.builtin.include_vars: vars/vprostacksetup

  - name: create vprofile EC2 key pair 
    amazon.aws.ec2_key:
      name: vprokey
      region: "{{region}}"
    register: vprokey_out

  - name: store private key into file loginkey_vpro.pem
    copy:
      content: "{{vprokey_out.key.private_key}}"
      dest: ./loginkey_vpro.pem
      mode: 0600
    when: vprokey_out.changed

  - name: Create sg for Load Balancer
    ec2_group:
      name: vpeoELB-sg
      description: Allow port 80 from every where and all port within sg 
      region: "{{region}}"
      vpc_id: "{{vpcid}}"
      rules:
      - proto: tcp
        from_port: 80
        to_port: 80
        cidr_ip: 0.0.0.0/0
    register: vproELBSG_out

  - name: Create sg for vprofile stack
    ec2_group:
      name: vpeoStack-sg
      description: Allow port 22 from every where and all port within sg 
      region: "{{region}}"
      vpc_id: "{{vpcid}}"
      purge_rules: no
      rules:
      - proto: tcp
        from_port: 80
        to_port: 80
        group_id: "{{vproELBSG_out.group_id}}"
      
      - proto: tcp
        from_port: 22
        to_port: 22
        group_id: "{{BastionSGid}}"
    register: vproStackSG_out

    
  